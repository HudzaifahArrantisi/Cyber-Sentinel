#!/usr/bin/env python3
"""
Vulnerability Scanning Example
Advanced vulnerability assessment example
"""

import sys
import os
import json
from datetime import datetime
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from src.scanner import AdvancedPortScanner
from src.detector import AttackDetector
from src.utils import print_banner, print_success, print_warning, print_error, print_info, DisplayUtils
from colorama import Fore, Style

class VulnerabilityScanner:
    """Comprehensive vulnerability scanner"""
    
    def __init__(self):
        self.scanner = AdvancedPortScanner()
        self.detector = AttackDetector()
        self.results = {}
        self.vulnerabilities = []
        
        # Vulnerability database
        self.vuln_db = self._load_vulnerability_database()
    
    def _load_vulnerability_database(self):
        """Load vulnerability database"""
        vuln_db = {
            # Web vulnerabilities
            80: [
                {"id": "WEB-001", "name": "Outdated Web Server", "severity": "Medium"},
                {"id": "WEB-002", "name": "Default Files Present", "severity": "Low"},
                {"id": "WEB-003", "name": "Directory Listing Enabled", "severity": "Medium"},
            ],
            443: [
                {"id": "SSL-001", "name": "Weak SSL/TLS Configuration", "severity": "High"},
                {"id": "SSL-002", "name": "Expired Certificate", "severity": "Medium"},
                {"id": "SSL-003", "name": "Self-Signed Certificate", "severity": "Low"},
            ],
            
            # Database vulnerabilities
            3306: [
                {"id": "DB-001", "name": "Default MySQL Credentials", "severity": "Critical"},
                {"id": "DB-002", "name": "Unauthenticated Access", "severity": "Critical"},
                {"id": "DB-003", "name": "Outdated MySQL Version", "severity": "High"},
            ],
            5432: [
                {"id": "DB-004", "name": "Default PostgreSQL Credentials", "severity": "Critical"},
            ],
            27017: [
                {"id": "DB-005", "name": "MongoDB No Authentication", "severity": "Critical"},
            ],
            
            # Remote access vulnerabilities
            22: [
                {"id": "RA-001", "name": "SSH Weak Algorithms", "severity": "Medium"},
                {"id": "RA-002", "name": "SSH Protocol v1", "severity": "High"},
                {"id": "RA-003", "name": "Root Login Allowed", "severity": "High"},
            ],
            23: [
                {"id": "RA-004", "name": "Telnet Cleartext Authentication", "severity": "Critical"},
            ],
            3389: [
                {"id": "RA-005", "name": "RDP Vulnerabilities", "severity": "High"},
                {"id": "RA-006", "name": "BlueKeep Vulnerability", "severity": "Critical"},
            ],
            
            # File sharing vulnerabilities
            445: [
                {"id": "FS-001", "name": "SMBv1 Enabled", "severity": "Critical"},
                {"id": "FS-002", "name": "EternalBlue Vulnerability", "severity": "Critical"},
                {"id": "FS-003", "name": "Null Session Allowed", "severity": "High"},
            ],
            2049: [
                {"id": "FS-004", "name": "NFS No Authentication", "severity": "High"},
            ],
            
            # Management vulnerabilities
            161: [
                {"id": "MGMT-001", "name": "SNMP Public Community", "severity": "High"},
                {"id": "MGMT-002", "name": "SNMP Cleartext", "severity": "Medium"},
            ],
            5900: [
                {"id": "MGMT-003", "name": "VNC No Authentication", "severity": "Critical"},
            ],
            
            # Other common vulnerabilities
            21: [
                {"id": "FTP-001", "name": "FTP Anonymous Login", "severity": "High"},
                {"id": "FTP-002", "name": "FTP Cleartext Authentication", "severity": "Critical"},
            ],
            25: [
                {"id": "SMTP-001", "name": "Open Relay", "severity": "High"},
            ],
            110: [
                {"id": "POP3-001", "name": "Cleartext Authentication", "severity": "High"},
            ],
            143: [
                {"id": "IMAP-001", "name": "Cleartext Authentication", "severity": "High"},
            ],
        }
        
        return vuln_db
    
    def scan_target(self, target, port_range="1-1000"):
        """Scan target for vulnerabilities"""
        print_info(f"Scanning target: {target}")
        
        # Perform port scan
        print_info("Performing port scan...")
        scan_results = self.scanner.comprehensive_scan(target, port_range)
        
        # Analyze for vulnerabilities
        print_info("Analyzing for vulnerabilities...")
        self._analyze_vulnerabilities(target, scan_results)
        
        return {
            'target': target,
            'scan_results': scan_results,
            'vulnerabilities': self.vulnerabilities
        }
    
    def _analyze_vulnerabilities(self, target, scan_results):
        """Analyze scan results for vulnerabilities"""
        self.vulnerabilities = []
        
        for port, result in scan_results.items():
            if result.state == 'open':
                # Check for known vulnerabilities based on port
                if port in self.vuln_db:
                    for vuln in self.vuln_db[port]:
                        # Check if vulnerability applies based on banner/version
                        if self._check_vulnerability_applies(result, vuln):
                            vulnerability = {
                                'id': vuln['id'],
                                'name': vuln['name'],
                                'severity': vuln['severity'],
                                'port': port,
                                'service': result.service,
                                'target': target,
                                'description': self._get_vulnerability_description(vuln['id']),
                                'remediation': self._get_remediation_steps(vuln['id']),
                                'evidence': f"Service {result.service} running on port {port}"
                            }
                            self.vulnerabilities.append(vulnerability)
                
                # Check banner for specific vulnerabilities
                if result.banner:
                    self._check_banner_for_vulnerabilities(target, port, result.banner)
    
    def _check_vulnerability_applies(self, result, vulnerability):
        """Check if vulnerability applies to this service"""
        # This is a simplified check
        # In real implementation, would check version numbers, banner info, etc.
        return True
    
    def _check_banner_for_vulnerabilities(self, target, port, banner):
        """Check banner for specific vulnerability indicators"""
        banner_lower = banner.lower()
        
        # Check for outdated software versions
        outdated_indicators = [
            ('apache/2.2', 'WEB-001', 'Outdated Apache 2.2'),
            ('nginx/1.14', 'WEB-001', 'Outdated Nginx'),
            ('openssh_6.0', 'RA-001', 'Outdated OpenSSH'),
            ('microsoft-iis/7.0', 'WEB-001', 'Outdated IIS'),
        ]
        
        for indicator, vuln_id, vuln_name in outdated_indicators:
            if indicator in banner_lower:
                self.vulnerabilities.append({
                    'id': vuln_id,
                    'name': vuln_name,
                    'severity': 'High',
                    'port': port,
                    'service': 'Unknown',
                    'target': target,
                    'description': f"Outdated software version detected: {indicator}",
                    'remediation': 'Update to latest version',
                    'evidence': f"Banner: {banner}"
                })
    
    def _get_vulnerability_description(self, vuln_id):
        """Get vulnerability description"""
        descriptions = {
            'WEB-001': 'Outdated web server software may contain known vulnerabilities',
            'SSL-001': 'Weak SSL/TLS configuration may allow cryptographic attacks',
            'DB-001': 'Default credentials are commonly known and easily guessed',
            'RA-004': 'Telnet transmits credentials in cleartext, vulnerable to sniffing',
            'FS-001': 'SMBv1 contains critical vulnerabilities including EternalBlue',
        }
        return descriptions.get(vuln_id, 'No description available')
    
    def _get_remediation_steps(self, vuln_id):
        """Get remediation steps for vulnerability"""
        remediations = {
            'WEB-001': 'Update web server to latest version, apply security patches',
            'SSL-001': 'Configure strong SSL/TLS settings, disable weak protocols',
            'DB-001': 'Change default credentials, use strong passwords',
            'RA-004': 'Disable Telnet, use SSH instead with key authentication',
            'FS-001': 'Disable SMBv1, enable SMBv2 or v3 with encryption',
        }
        return remediations.get(vuln_id, 'Consult security documentation')
    
    def generate_report(self, output_file=None):
        """Generate vulnerability assessment report"""
        report = {
            'generated_at': datetime.now().isoformat(),
            'target': self.results.get('target', 'Unknown'),
            'vulnerability_count': len(self.vulnerabilities),
            'vulnerabilities': self.vulnerabilities,
            'severity_summary': self._get_severity_summary()
        }
        
        if output_file:
            with open(output_file, 'w') as f:
                json.dump(report, f, indent=2)
            print_success(f"Report saved to {output_file}")
        
        return report
    
    def _get_severity_summary(self):
        """Get vulnerability severity summary"""
        summary = {'Critical': 0, 'High': 0, 'Medium': 0, 'Low': 0}
        
        for vuln in self.vulnerabilities:
            severity = vuln['severity']
            if severity in summary:
                summary[severity] += 1
        
        return summary
    
    def display_results(self):
        """Display vulnerability scan results"""
        if not self.vulnerabilities:
            print_success("No vulnerabilities found!")
            return
        
        print(f"\n{Fore.CYAN}{'='*80}")
        print(f"{Fore.YELLOW}VULNERABILITY ASSESSMENT RESULTS")
        print(f"{Fore.CYAN}{'='*80}")
        
        # Group by severity
        by_severity = {'Critical': [], 'High': [], 'Medium': [], 'Low': []}
        
        for vuln in self.vulnerabilities:
            by_severity[vuln['severity']].append(vuln)
        
        # Display by severity
        for severity in ['Critical', 'High', 'Medium', 'Low']:
            vulns = by_severity[severity]
            if vulns:
                color = {
                    'Critical': Fore.RED + Style.BRIGHT,
                    'High': Fore.RED,
                    'Medium': Fore.YELLOW,
                    'Low': Fore.BLUE
                }[severity]
                
                print(f"\n{color}{severity} Vulnerabilities ({len(vulns)}):")
                print(f"{Fore.WHITE}{'-'*80}")
                
                for i, vuln in enumerate(vulns, 1):
                    print(f"{color}{i}. {vuln['name']} [{vuln['id']}]")
                    print(f"{Fore.WHITE}   Port: {vuln['port']} ({vuln['service']})")
                    print(f"   Description: {vuln['description']}")
                    print(f"   Remediation: {vuln['remediation']}")
                    print(f"   Evidence: {vuln['evidence'][:80]}...")
                    print()
        
        # Display summary
        print(f"{Fore.CYAN}{'='*80}")
        print(f"{Fore.YELLOW}SUMMARY:")
        summary = self._get_severity_summary()
        for severity, count in summary.items():
            if count > 0:
                print(f"  {severity}: {count}")
        print(f"{Fore.CYAN}{'='*80}")

def single_target_scan():
    """Scan single target for vulnerabilities"""
    print_banner()
    
    print(f"{Fore.CYAN}[*] Single Target Vulnerability Scan")
    print(f"{Fore.CYAN}{'='*60}")
    
    target = input(f"{Fore.GREEN}[?] Enter target IP address: ").strip()
    
    if not target:
        print_error("No target specified")
        return
    
    scanner = VulnerabilityScanner()
    
    print_info(f"Starting vulnerability scan on {target}...")
    
    # Perform scan
    results = scanner.scan_target(target)
    scanner.results = results
    
    # Display results
    scanner.display_results()
    
    # Generate report
    save = input(f"\n{Fore.GREEN}[?] Generate report? (y/N): ").strip().lower()
    if save == 'y':
        filename = input(f"{Fore.GREEN}[?] Enter filename (default: vuln_report.json): ").strip()
        filename = filename or "vuln_report.json"
        scanner.generate_report(filename)

def network_range_scan():
    """Scan network range for vulnerabilities"""
    print_banner()
    
    print(f"{Fore.CYAN}[*] Network Range Vulnerability Scan")
    print(f"{Fore.CYAN}{'='*60}")
    
    network_range = input(f"{Fore.GREEN}[?] Enter network range (e.g., 192.168.1.0/24): ").strip()
    
    if not network_range:
        print_error("No network range specified")
        return
    
    from src.utils import NetworkUtils
    
    print_info(f"Scanning network range: {network_range}")
    print_warning("This may take a long time!")
    
    confirm = input(f"{Fore.GREEN}[?] Continue? (y/N): ").strip().lower()
    if confirm != 'y':
        return
    
    # Simple implementation - scan first few hosts
    try:
        import ipaddress
        network = ipaddress.ip_network(network_range, strict=False)
        
        scanner = VulnerabilityScanner()
        all_vulnerabilities = []
        
        # Limit to first 5 hosts for example
        hosts = list(network.hosts())[:5]
        
        for host in hosts:
            target = str(host)
            print_info(f"Scanning {target}...")
            
            # Check if host is alive
            if NetworkUtils.ping_host(target):
                results = scanner.scan_target(target, "1-100")
                all_vulnerabilities.extend(results['vulnerabilities'])
            else:
                print_info(f"Host {target} is not responding")
        
        # Display results
        if all_vulnerabilities:
            print(f"\n{Fore.RED}[!] Found {len(all_vulnerabilities)} vulnerabilities across network:")
            for vuln in all_vulnerabilities:
                print(f"{Fore.YELLOW}  {vuln['target']}:{vuln['port']} - {vuln['name']}")
        else:
            print_success("No vulnerabilities found in scanned hosts")
            
    except Exception as e:
        print_error(f"Error scanning network: {e}")

def load_and_analyze_results():
    """Load and analyze existing scan results"""
    print_banner()
    
    print(f"{Fore.CYAN}[*] Analyze Existing Scan Results")
    print(f"{Fore.CYAN}{'='*60}")
    
    filename = input(f"{Fore.GREEN}[?] Enter scan results file: ").strip()
    
    if not os.path.exists(filename):
        print_error("File not found!")
        return
    
    try:
        with open(filename, 'r') as f:
            data = json.load(f)
        
        print_info(f"Loaded results for {data.get('target', 'Unknown')}")
        
        # Analyze vulnerabilities
        detector = AttackDetector()
        
        if 'open_ports' in data:
            vuln_alerts = detector.analyze_vulnerabilities(data['open_ports'])
            detector.display_alerts(vuln_alerts)
        
        print_success("Analysis complete!")
        
    except Exception as e:
        print_error(f"Error loading file: {e}")

def main():
    """Main vulnerability scanner menu"""
    print_banner()
    
    while True:
        print(f"\n{Fore.CYAN}{'='*60}")
        print(f"{Fore.YELLOW}VULNERABILITY SCANNER")
        print(f"{Fore.CYAN}{'='*60}")
        print(f"{Fore.WHITE}1. Scan Single Target")
        print(f"{Fore.WHITE}2. Scan Network Range")
        print(f"{Fore.WHITE}3. Analyze Existing Results")
        print(f"{Fore.WHITE}4. Generate Test Report")
        print(f"{Fore.WHITE}5. Exit")
        print(f"{Fore.CYAN}{'='*60}")
        
        choice = input(f"\n{Fore.GREEN}[?] Select option (1-5): ").strip()
        
        if choice == '1':
            single_target_scan()
        elif choice == '2':
            network_range_scan()
        elif choice == '3':
            load_and_analyze_results()
        elif choice == '4':
            generate_test_report()
        elif choice == '5':
            print_info("Exiting...")
            break
        else:
            print_error("Invalid choice!")

def generate_test_report():
    """Generate a sample vulnerability report"""
    print_info("Generating sample vulnerability report...")
    
    sample_vulns = [
        {
            'id': 'WEB-001',
            'name': 'Outdated Apache Version',
            'severity': 'High',
            'port': 80,
            'service': 'http',
            'target': '192.168.1.1',
            'description': 'Apache 2.2.15 detected, contains multiple known vulnerabilities',
            'remediation': 'Update to Apache 2.4.x or later',
            'evidence': 'Server: Apache/2.2.15 (CentOS)'
        },
        {
            'id': 'SSL-001',
            'name': 'Weak SSL/TLS Configuration',
            'severity': 'Medium',
            'port': 443,
            'service': 'https',
            'target': '192.168.1.1',
            'description': 'Supports TLS 1.0 and weak cipher suites',
            'remediation': 'Disable TLS 1.0, use strong cipher suites only',
            'evidence': 'TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA'
        },
        {
            'id': 'RA-003',
            'name': 'SSH Root Login Allowed',
            'severity': 'Critical',
            'port': 22,
            'service': 'ssh',
            'target': '192.168.1.10',
            'description': 'Root login via SSH is permitted',
            'remediation': 'Disable root login in sshd_config',
            'evidence': 'PermitRootLogin yes detected'
        }
    ]
    
    report = {
        'generated_at': datetime.now().isoformat(),
        'target': 'Test Network',
        'vulnerability_count': len(sample_vulns),
        'vulnerabilities': sample_vulns,
        'severity_summary': {'Critical': 1, 'High': 1, 'Medium': 1, 'Low': 0}
    }
    
    filename = "sample_vulnerability_report.json"
    with open(filename, 'w') as f:
        json.dump(report, f, indent=2)
    
    print_success(f"Sample report generated: {filename}")
    
    # Display the report
    print(f"\n{Fore.CYAN}{'='*60}")
    print(f"{Fore.YELLOW}SAMPLE VULNERABILITY REPORT")
    print(f"{Fore.CYAN}{'='*60}")
    
    for vuln in sample_vulns:
        color = {
            'Critical': Fore.RED + Style.BRIGHT,
            'High': Fore.RED,
            'Medium': Fore.YELLOW
        }[vuln['severity']]
        
        print(f"\n{color}{vuln['name']} ({vuln['severity']})")
        print(f"{Fore.WHITE}Target: {vuln['target']}:{vuln['port']}")
        print(f"Description: {vuln['description']}")
        print(f"Remediation: {vuln['remediation']}")

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n{Fore.YELLOW}[*] Vulnerability scanner stopped by user")
    except Exception as e:
        print_error(f"Error: {e}")